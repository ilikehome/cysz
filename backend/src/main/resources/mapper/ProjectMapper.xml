<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cysz.property.mapper.ProjectMapper">

    <!-- 项目VO结果映射 -->
    <resultMap id="ProjectVOMap" type="com.cysz.property.vo.ProjectVO">
        <id column="id" property="id"/>
        <result column="project_name" property="name"/>
        <result column="project_type" property="type"/>
        <result column="company_name" property="companyName"/>
        <result column="rent_bill_company" property="rentBillCompany"/>
        <result column="property_bill_company" property="propertyBillCompany"/>
        <result column="property_right_company" property="propertyRightCompany"/>
        <result column="building_area" property="buildingArea"/>
        <result column="rent_area" property="rentArea"/>
        <result column="property_area" property="propertyArea"/>
        <result column="city" property="city"/>
        <result column="address" property="address"/>
        <result column="status" property="status"/>
        <result column="management_org" property="managementOrg"/>
        <result column="rent_bill_bank_account" property="rentBillBankAccount"/>
        <result column="project_manager" property="projectManager"/>
        <result column="contact_phone" property="contactPhone"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 基础查询字段 -->
    <sql id="BaseColumns">
        id, project_name, project_type, company_name, rent_bill_company, 
        property_bill_company, property_right_company, building_area, rent_area, 
        property_area, city, address, status, management_org, rent_bill_bank_account, 
        project_manager, contact_phone, create_time, update_time
    </sql>

    <!-- 查询条件 -->
    <sql id="QueryConditions">
        <where>
            1 = 1
            <if test="query.name != null and query.name.trim() != ''">
                AND project_name LIKE CONCAT('%', #{query.name}, '%')
            </if>
            <if test="query.type != null and query.type.trim() != ''">
                AND project_type = #{query.type}
            </if>
            <if test="query.status != null">
                AND status = #{query.status}
            </if>
            <if test="query.city != null and query.city.trim() != ''">
                AND city LIKE CONCAT('%', #{query.city}, '%')
            </if>
            <if test="query.address != null and query.address.trim() != ''">
                AND address LIKE CONCAT('%', #{query.address}, '%')
            </if>
            <if test="query.companyName != null and query.companyName.trim() != ''">
                AND company_name LIKE CONCAT('%', #{query.companyName}, '%')
            </if>
            <if test="query.projectManager != null and query.projectManager.trim() != ''">
                AND project_manager LIKE CONCAT('%', #{query.projectManager}, '%')
            </if>
            <if test="query.keyword != null and query.keyword.trim() != ''">
                AND (
                    project_name LIKE CONCAT('%', #{query.keyword}, '%')
                    OR city LIKE CONCAT('%', #{query.keyword}, '%')
                    OR address LIKE CONCAT('%', #{query.keyword}, '%')
                    OR company_name LIKE CONCAT('%', #{query.keyword}, '%')
                    OR project_manager LIKE CONCAT('%', #{query.keyword}, '%')
                )
            </if>
        </where>
    </sql>

    <!-- 排序条件 -->
    <sql id="OrderBy">
        <choose>
            <when test="query.sortField != null and query.sortField.trim() != ''">
                ORDER BY ${query.sortField} ${query.sortOrder}
            </when>
            <otherwise>
                ORDER BY create_time DESC
            </otherwise>
        </choose>
    </sql>

    <!-- 分页查询项目列表 -->
    <select id="selectProjectPage" resultMap="ProjectVOMap">
        SELECT
        <include refid="BaseColumns"/>,
        CASE project_type
            WHEN 'APARTMENT' THEN '公寓'
            WHEN 'COMMERCIAL_DISTRICT' THEN '商业街'
            WHEN 'OFFICE' THEN '写字楼'
            WHEN 'COMPLEX' THEN '综合体'
            WHEN 'HOTEL' THEN '酒店'
            ELSE project_type
        END AS typeName,
        CASE status
            WHEN 1 THEN '启用'
            WHEN 0 THEN '禁用'
            ELSE '未知'
        END AS statusName
        FROM project
        <include refid="QueryConditions"/>
        <include refid="OrderBy"/>
    </select>

    <!-- 根据ID查询项目详情 -->
    <select id="selectProjectById" resultMap="ProjectVOMap">
        SELECT
        <include refid="BaseColumns"/>,
        CASE project_type
            WHEN 'APARTMENT' THEN '公寓'
            WHEN 'COMMERCIAL_DISTRICT' THEN '商业街'
            WHEN 'OFFICE' THEN '写字楼'
            WHEN 'COMPLEX' THEN '综合体'
            WHEN 'HOTEL' THEN '酒店'
            ELSE project_type
        END AS typeName,
        CASE status
            WHEN 1 THEN '启用'
            WHEN 0 THEN '禁用'
            ELSE '未知'
        END AS statusName
        FROM project
        WHERE id = #{id}
    </select>

    <!-- 查询所有项目列表（用于下拉选择） -->
    <select id="selectProjectList" resultMap="ProjectVOMap">
        SELECT id, project_name, project_type, status
        FROM project
        WHERE status = 1
        ORDER BY project_name ASC
    </select>

    <!-- 根据名称查询项目 -->
    <select id="selectByName" resultType="com.cysz.property.entity.Project">
        SELECT * FROM project
        WHERE project_name = #{name}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
        LIMIT 1
    </select>

    <!-- 统计项目数量 -->
    <select id="countProjects" resultType="java.lang.Long">
        SELECT COUNT(*) FROM project
        <include refid="QueryConditions"/>
    </select>

</mapper>